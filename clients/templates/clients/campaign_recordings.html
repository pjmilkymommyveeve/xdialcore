{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ campaign.name }} Recordings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .table-hover:hover { background-color: #f9fafb; }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: all 0.15s;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        
        .btn-outline {
            background-color: white;
            color: #6b7280;
            border: 1px solid #d1d5db;
        }
        
        .btn-outline:hover {
            background-color: #f9fafb;
            color: #374151;
        }
        
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.813rem;
        }
        
        /* Sortable Table Headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        th.sortable:hover {
            background-color: #e5e7eb;
        }
        
        th.sortable .sort-icon {
            margin-left: 0.25rem;
            font-size: 0.75rem;
            opacity: 0.3;
        }
        
        th.sortable.active .sort-icon {
            opacity: 1;
        }
        
        /* Audio Player */
        .audio-player {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .player-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .player-info {
            min-width: 200px;
        }
        
        .player-phone {
            font-size: 0.875rem;
            font-weight: 600;
            color: #111827;
        }
        
        .player-meta {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.125rem;
        }
        
        .player-controls {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .control-btn {
            background: white;
            border: 1px solid #d1d5db;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            font-size: 0.875rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: #f9fafb;
            color: #374151;
        }
        
        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .control-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .control-btn.active:hover {
            background: #2563eb;
            border-color: #2563eb;
        }
        
        .play-btn {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 0.375rem;
            background: #3b82f6;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            font-size: 0.875rem;
        }
        
        .play-btn:hover {
            background: #2563eb;
        }
        
        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .time {
            font-size: 0.75rem;
            color: #6b7280;
            min-width: 2.5rem;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }
        
        .progress-bar {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            border-radius: 3px;
            transition: width 0.1s linear;
        }
        
        tr.playing {
            background-color: #eff6ff;
        }

        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .page-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.15s;
        }

        .page-btn:hover:not(:disabled) {
            background: #f9fafb;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .page-info {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                </svg>
                <div>
                    <p class="text-lg font-medium text-blue-600">{{ client_name }}</p>
                    <p class="text-sm text-gray-600">{{ campaign.name }} - {{ campaign.model }}</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="{% url 'clients:campaign_dashboard' campaign.id %}" class="inline-flex items-center gap-2 px-4 py-2 border bg-white shadow-sm hover:bg-gray-50 rounded-md text-sm font-medium">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Dashboard
                </a>
                <a href="{% url 'clients:data_export' campaign.id %}" class="inline-flex items-center gap-2 px-4 py-2 border bg-white shadow-sm hover:bg-gray-50 rounded-md text-sm font-medium">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Data Export
                </a>
                <a href="{% url 'clients:client_landing' %}" class="inline-flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-md text-sm font-medium">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Back
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% if error %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-red-800">{{ error }}</p>
        </div>
        {% elif not has_servers %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <p class="text-sm text-yellow-800">No recording servers are configured for this campaign.</p>
        </div>
        {% endif %}

        <!-- Search & Filter Section -->
        <div class="bg-white rounded-xl border py-6 shadow-sm mb-6">
            <div class="px-6 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <h2 class="text-lg font-semibold">Search Recordings</h2>
                </div>
                <p class="text-sm text-gray-600 mt-2">Select a date to view recordings. Add a phone number to filter results.</p>
            </div>
            
            <div class="px-6 space-y-4">
                <div class="flex gap-4">
                    <div class="flex-1">
                        <input type="date" id="dateInput" class="flex h-9 w-full rounded-md border border-gray-300 bg-transparent px-3 py-1 text-sm">
                    </div>
                    <div class="flex-1">
                        <input type="text" id="phoneSearch" placeholder="Filter by phone number..." class="flex h-9 w-full rounded-md border border-gray-300 bg-transparent px-3 py-1 text-sm">
                    </div>
                    <button id="searchBtn" class="btn btn-primary">
                        <i class="fas fa-search mr-2"></i>
                        Search
                    </button>
                    <button id="resetBtn" class="btn btn-outline">
                        <i class="fas fa-sync-alt mr-2"></i>
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Recordings List Section -->
        <div class="bg-white rounded-xl border py-6 shadow-sm">
            <div class="px-6 mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                            </svg>
                            <h2 class="text-lg font-semibold">Call Recordings</h2>
                        </div>
                        <p id="recordingCount" class="text-sm text-gray-600">Select a date to load recordings</p>
                    </div>
                </div>
            </div>

            <div class="px-6">
                <!-- Audio Player -->
                <div id="audioPlayer" class="audio-player hidden">
                    <audio id="audioElement"></audio>
                    <div class="player-container">
                        <div class="player-info">
                            <div class="player-phone" id="playerPhone">No recording selected</div>
                            <div class="player-meta" id="playerMeta">Select a recording to play</div>
                        </div>

                        <div class="player-controls">
                            <button class="control-btn" id="prevBtn" onclick="playPrevious()" title="Previous" disabled>
                                <i class="fas fa-step-backward"></i>
                            </button>
                            
                            <button class="play-btn" id="playPauseBtn" onclick="togglePlayPause()" disabled>
                                <i class="fas fa-play"></i>
                            </button>
                            
                            <button class="control-btn" id="nextBtn" onclick="playNext()" title="Next" disabled>
                                <i class="fas fa-step-forward"></i>
                            </button>
                            
                            <div class="progress-wrapper">
                                <span class="time" id="currentTime">0:00</span>
                                <div class="progress-bar" onclick="seekAudio(event)">
                                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                </div>
                                <span class="time" id="totalTime">0:00</span>
                            </div>
                            
                            <button class="control-btn" id="autoplayBtn" onclick="toggleAutoplay()" title="Autoplay">
                                <i class="fas fa-repeat"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="loadingState" class="hidden text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-2 text-sm text-gray-600">Loading recordings...</p>
                </div>

                <div id="recordingsTable" class="hidden overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200 bg-gray-50">
                                <th class="text-left py-3 px-4 font-medium text-gray-700 sortable" onclick="sortTable('time')">
                                    Time
                                    <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700 sortable" onclick="sortTable('phone')">
                                    Phone Number
                                    <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700 sortable" onclick="sortTable('duration')">
                                    Duration
                                    <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700 sortable" onclick="sortTable('size')">
                                    Size
                                    <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="text-left py-3 px-4 font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordingsBody">
                            <!-- Recordings will be inserted here -->
                        </tbody>
                    </table>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination" id="paginationControls">
                        <button class="page-btn" id="firstPageBtn" onclick="goToPage(1)">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="page-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <span class="page-info" id="pageInfo">Page 1 of 1</span>
                        <button class="page-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="page-btn" id="lastPageBtn" onclick="goToPage(totalPages)">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>

                <div id="emptyState" class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">Select a date and click Search to view recordings</p>
                </div>

                <div id="errorState" class="hidden text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="mt-2 text-sm text-red-600" id="errorMessage">Error loading recordings</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        const serverConfigs = {{ server_configs|safe }};
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateInput').value = today;

        let currentRecordings = [];
        let currentAudio = document.getElementById('audioElement');
        let currentRow = null;
        let isPlaying = false;
        let autoplayEnabled = false;
        let currentSortColumn = 'time';
        let currentSortDirection = 'desc';
        let currentPage = 1;
        let totalPages = 1;
        let totalCount = 0;
        let pageSize = 100;

        document.getElementById('dateInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                fetchRecordings();
            }
        });

        document.getElementById('phoneSearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                fetchRecordings();
            }
        });

        // Sorting function - now triggers server-side sort
        function sortTable(column) {
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Update sort icons
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('active');
                const icon = th.querySelector('.sort-icon');
                icon.className = 'fas fa-sort sort-icon';
            });

            const activeHeader = event.currentTarget;
            activeHeader.classList.add('active');
            const activeIcon = activeHeader.querySelector('.sort-icon');
            activeIcon.className = currentSortDirection === 'asc' ? 
                'fas fa-sort-up sort-icon' : 'fas fa-sort-down sort-icon';

            // Fetch with new sort
            currentPage = 1;
            fetchRecordings();
        }

        // Pagination function
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            fetchRecordings();
        }

        function updatePaginationControls() {
            document.getElementById('pageInfo').textContent = 
                `Page ${currentPage} of ${totalPages} (${totalCount} total)`;
            
            document.getElementById('firstPageBtn').disabled = currentPage === 1;
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
        }

        async function fetchRecordings() {
            const dateValue = document.getElementById('dateInput').value;
            const phoneValue = document.getElementById('phoneSearch').value.trim();
            
            if (!dateValue) {
                showEmptyState('Please select a date');
                return;
            }

            const dateFormatted = dateValue.replace(/-/g, '');
            showLoadingState();

            try {
                const promises = serverConfigs.map(config => 
                    fetchFromServer(config, dateFormatted, phoneValue)
                );
                
                const results = await Promise.all(promises);
                
                // Combine results from all servers
                const combinedData = results.reduce((acc, result) => {
                    return {
                        recordings: [...acc.recordings, ...result.recordings],
                        total_count: acc.total_count + result.total_count
                    };
                }, { recordings: [], total_count: 0 });

                currentRecordings = combinedData.recordings;
                totalCount = combinedData.total_count;
                totalPages = Math.ceil(totalCount / pageSize);
                
                displayRecordings(currentRecordings);
            } catch (error) {
                console.error('Error fetching recordings:', error);
                showErrorState(error.message);
            }
        }

        async function fetchFromServer(config, date, phoneNumber) {
            const params = new URLSearchParams({
                server_id: config.server_id,
                date: date,
                extension: config.extension,
                page: currentPage,
                page_size: pageSize,
                sort_by: currentSortColumn,
                sort_dir: currentSortDirection
            });

            if (phoneNumber) {
                params.append('number', phoneNumber);
            }

            const url = `/clients/api/recordings/?${params.toString()}`;

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error(`Error from server ${config.alias}`);
                    return { recordings: [], total_count: 0 };
                }

                const data = await response.json();
                
                // Map recordings with server info
                const recordings = (data.recordings || []).map(recording => ({
                    ...recording,
                    server_alias: config.alias,
                    extension: config.extension
                }));

                return {
                    recordings: recordings,
                    total_count: data.total_count || 0
                };
            } catch (error) {
                console.error(`Failed to fetch from server ${config.alias}:`, error);
                return { recordings: [], total_count: 0 };
            }
        }

        function displayRecordings(recordings) {
            const tbody = document.getElementById('recordingsBody');
            const countEl = document.getElementById('recordingCount');
            
            if (recordings.length === 0) {
                showEmptyState('No recordings found');
                return;
            }

            tbody.innerHTML = '';
            recordings.forEach((recording, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100 table-hover';
                row.dataset.index = index;
                row.dataset.phone = recording.phone_number || recording.number || 'Unknown';
                row.dataset.time = recording.time || '';
                row.dataset.duration = recording.duration || '';
                row.dataset.url = recording.url || '';
                
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm text-gray-600">${recording.time || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm text-gray-900 font-medium">${recording.phone_number || recording.number || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm text-gray-600">${recording.duration || 'N/A'}</td>
                    <td class="py-3 px-4 text-sm text-gray-500">${recording.size || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center gap-2">
                            <button class="btn btn-outline btn-sm" onclick="playRecording(this)">
                                <i class="fas fa-play mr-1"></i>
                                Play
                            </button>
                            <a href="${recording.url || '#'}" download class="btn btn-outline btn-sm">
                                <i class="fas fa-download mr-1"></i>
                                Download
                            </a>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            const startIdx = (currentPage - 1) * pageSize + 1;
            const endIdx = Math.min(currentPage * pageSize, totalCount);
            countEl.textContent = `Showing ${startIdx}-${endIdx} of ${totalCount} recording${totalCount !== 1 ? 's' : ''}`;
            
            showTableState();
            updatePaginationControls();
            document.getElementById('audioPlayer').classList.remove('hidden');
        }

        function playRecording(button) {
            const row = button.closest('tr');
            loadAndPlayRow(row);
        }

        function loadAndPlayRow(row) {
            if (!row) return;

            const phone = row.dataset.phone;
            const time = row.dataset.time;
            const url = row.dataset.url;

            if (!url) {
                alert('Recording URL not available');
                return;
            }

            document.getElementById('playerPhone').textContent = phone;
            document.getElementById('playerMeta').textContent = time;
            document.getElementById('playPauseBtn').disabled = false;

            if (currentRow) {
                currentRow.classList.remove('playing');
            }
            row.classList.add('playing');
            currentRow = row;

            updateNavigationButtons();

            currentAudio.src = url;
            currentAudio.play();
            isPlaying = true;
            updatePlayPauseButton();
        }

        function toggleAutoplay() {
            autoplayEnabled = !autoplayEnabled;
            const btn = document.getElementById('autoplayBtn');
            
            if (autoplayEnabled) {
                btn.classList.add('active');
                btn.title = 'Autoplay: ON';
            } else {
                btn.classList.remove('active');
                btn.title = 'Autoplay: OFF';
            }
        }

        function playNext() {
            if (!currentRow) return;
            const allRows = Array.from(document.querySelectorAll('#recordingsBody tr'));
            const currentIndex = allRows.indexOf(currentRow);
            
            if (currentIndex < allRows.length - 1) {
                loadAndPlayRow(allRows[currentIndex + 1]);
            } else if (currentPage < totalPages) {
                // Auto-load next page if autoplay is on
                if (autoplayEnabled) {
                    goToPage(currentPage + 1);
                    // Play first recording after page loads
                    setTimeout(() => {
                        const firstRow = document.querySelector('#recordingsBody tr');
                        if (firstRow) loadAndPlayRow(firstRow);
                    }, 500);
                }
            }
        }

        function playPrevious() {
            if (!currentRow) return;
            const allRows = Array.from(document.querySelectorAll('#recordingsBody tr'));
            const currentIndex = allRows.indexOf(currentRow);
            
            if (currentIndex > 0) {
                loadAndPlayRow(allRows[currentIndex - 1]);
            } else if (currentPage > 1) {
                // Go to previous page
                goToPage(currentPage - 1);
                // Play last recording after page loads
                setTimeout(() => {
                    const rows = document.querySelectorAll('#recordingsBody tr');
                    const lastRow = rows[rows.length - 1];
                    if (lastRow) loadAndPlayRow(lastRow);
                }, 500);
            }
        }

        function updateNavigationButtons() {
            const allRows = Array.from(document.querySelectorAll('#recordingsBody tr'));
            const currentIndex = currentRow ? allRows.indexOf(currentRow) : -1;
            
            document.getElementById('prevBtn').disabled = currentIndex === 0 && currentPage === 1;
            document.getElementById('nextBtn').disabled = 
                currentIndex === allRows.length - 1 && currentPage === totalPages;
        }

        function togglePlayPause() {
            if (isPlaying) {
                currentAudio.pause();
                isPlaying = false;
            } else {
                currentAudio.play();
                isPlaying = true;
            }
            updatePlayPauseButton();
        }

        function updatePlayPauseButton() {
            const icon = document.querySelector('#playPauseBtn i');
            icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
        }

        function seekAudio(event) {
            const progressBar = event.currentTarget;
            const clickX = event.offsetX;
            const width = progressBar.offsetWidth;
            const percentage = clickX / width;
            currentAudio.currentTime = currentAudio.duration * percentage;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        currentAudio.addEventListener('timeupdate', function() {
            const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentTime').textContent = formatTime(currentAudio.currentTime);
        });

        currentAudio.addEventListener('loadedmetadata', function() {
            document.getElementById('totalTime').textContent = formatTime(currentAudio.duration);
        });

        currentAudio.addEventListener('ended', function() {
            isPlaying = false;
            updatePlayPauseButton();
            
            if (autoplayEnabled) {
                playNext();
            }
        });

        function showLoadingState() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('recordingsTable').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('audioPlayer').classList.add('hidden');
        }

        function showTableState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('recordingsTable').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
        }

        function showEmptyState(message = 'No recordings found') {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('recordingsTable').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('emptyState').querySelector('p').textContent = message;
            document.getElementById('recordingCount').textContent = message;
            document.getElementById('audioPlayer').classList.add('hidden');
        }

        function showErrorState(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('recordingsTable').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('recordingCount').textContent = 'Error loading recordings';
            document.getElementById('audioPlayer').classList.add('hidden');
        }

        document.getElementById('searchBtn').addEventListener('click', fetchRecordings);
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            document.getElementById('dateInput').value = today;
            document.getElementById('phoneSearch').value = '';
            currentRecordings = [];
            currentAudio.pause();
            isPlaying = false;
            if (currentRow) {
                currentRow.classList.remove('playing');
            }
            currentRow = null;
            currentSortColumn = 'time';
            currentSortDirection = 'desc';
            currentPage = 1;
            totalPages = 1;
            totalCount = 0;
            
            // Reset sort icons
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('active');
                const icon = th.querySelector('.sort-icon');
                icon.className = 'fas fa-sort sort-icon';
            });
            
            showEmptyState('Select a date and click Search to view recordings');
        });
    </script>
</body>
</html>